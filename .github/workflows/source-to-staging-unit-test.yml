name: Source to Staging (Data Engineering)

on:
  pull_request:
    branches:
      - dev-main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        pip install requests
        pip install databricks-cli
        pip install pyyaml

    - name: Configure Databricks CLI
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_DATA_ENGINEERING_TOKEN }}
      run: |
        echo -e "[DEFAULT]\nhost = $DATABRICKS_HOST\ntoken = $DATABRICKS_TOKEN" > ~/.databrickscfg

    - name: Debug Environment Variables
      run: |
        echo "DATABRICKS_HOST: $DATABRICKS_HOST"
        echo "DATABRICKS_TOKEN: $DATABRICKS_TOKEN"

    - name: Debug Payload Creation
      run: |
        echo "Creating JSON payload"
        cat <<EOF > payload.json
        {
          "run_name": "unit-test-notebook",
          "new_cluster": {
            "spark_version": "7.3.x-scala2.12",
            "node_type_id": "Standard_DS3_v2",
            "num_workers": 2
          },
          "notebook_task": {
            "notebook_path": "/Workspace/Users/smajumder1@ua.edu/Data-Engineering/era5-daily/00_Source_to_Staging/unit-test"
          }
        }
        EOF
        echo "Payload JSON created:"
        cat payload.json

    - name: Run Databricks Notebook
      env:
        DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
        DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_DATA_ENGINEERING_TOKEN }}
      run: |
        echo "Submitting the following JSON payload:"
        cat payload.json
        databricks runs submit --json-file payload.json

